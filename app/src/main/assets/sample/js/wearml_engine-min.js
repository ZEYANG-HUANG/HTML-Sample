/**
* MIT License
*
* Copyright (c) 2018  RealWear
* 
* Permission is hereby granted, free of charge, to any person obtaining a copy
* of this software and associated documentation files (the "Software"), to deal
* in the Software without restriction, including without limitation the rights
* to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
* copies of the Software, and to permit persons to whom the Software is
* furnished to do so, subject to the following conditions:
*
* The above copyright notice and this permission notice shall be included in all
* copies or substantial portions of the Software.
*
* THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
* IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
* FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
* AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
* LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
* OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
* SOFTWARE.
*/
var wearML=new function(){this.voiceCommandsCallBack,this.config={attributes:!1,childList:!0,subtree:!0,characterData:!1},this.observer=new MutationObserver(function(t){t.forEach(function(t){this.removedNodes=Array.from(t.removedNodes),this.addedNodes=Array.from(t.addedNodes),(this.removedNodes.length>0||this.addedNodes.length>0)&&wearML.pollCommands()})}),window.addEventListener("load",function(){wearML.getCommands()},!1),this.wearMLElements=[],this.wearHFButtons=[],this.root="--root",this.text_field="--text_field",this.overlay_show_number="--overlay_show_number",this.overlay_show_text="--overlay_show_text",this.overlay_persists="--overlay_persists",this.overlay_orientation="--overlay_orientation",this.overlay_background_color="--overlay_background_color",this.overlay_text_color="--overlay_text_color",this.overlay_border_color="--overlay_border_color",this.overlay_anchor_hv="--overlay_anchor_hv",this.overlay_show_dot="--overlay_show_dot",this.overlay_show_icon="--overlay_show_icon",this.overlay_offset="--overlay_offset",this.hf_scroll="--hf_scroll",this.barcode="--hf_barcode",this.global="--global_commands",this.hide_help="--hide_help",this.broadcast_results="--broadcast_results",this.root_text_field="",this.root_overlay_show_number="",this.root_overlay_show_text="",this.root_overlay_persists="",this.root_overlay_orientation="",this.root_overlay_background_color="",this.root_overlay_text_color="",this.root_overlay_border_color="",this.root_overlay_anchor_hv="",this.root_overlay_show_dot="",this.root_overlay_show_icon="",this.root_overlay_offset="",this.root_hf_scroll="",this.root_hide_help="",this.getCommands=function(){!navigator.userAgent.match(/Android/i)&&screen.width>480&&screen.height>854||(wearML.observer.disconnect(),this.elements=wearML.getAllElementsWithAttribute("*"),wearML.createOverrideDom(),this.rootElement=document.documentElement,wearML.observer.observe(this.rootElement,wearML.config))},this.ASRPolling,this.getAllElementsWithAttribute=function(t){for(e=0;e<wearML.wearHFButtons.length;e++)document.body.removeChild(wearML.wearHFButtons[e]);wearML.wearHFButtons=[],this.allElements=document.body.getElementsByTagName(t);for(var e=0,o=this.allElements.length;e<o;e++)if(this.currentElement=this.allElements[e],null!==this.currentElement.getAttribute("data-wml-style")||null!==this.currentElement.getAttribute("data-wml-speech-command")||"DIV"!=this.currentElement.tagName){if("SCRIPT"==this.currentElement.tagName)return;this.styleId=this.currentElement.getAttribute("data-wml-style"),this.command=this.currentElement.text,this.speech_command=this.currentElement.getAttribute("data-wml-speech-command"),void 0==this.speech_command||" "==this.speech_command||""==this.speech_command||(this.command=this.speech_command,""===this.currentElement.id&&(this.currentElement.id=this.guid()),this.position=this.getPosition(this.currentElement),this.element={tag:this.command,id:this.currentElement.id,x:this.position.x,y:this.position.y,styleId:this.styleId},wearML.wearMLElements.push(this.element),this.currentElement.addEventListener("click",this.onReceivedCommand.bind(this.currentElement,this.command)),void 0!=this.voiceCommandsCallBack&&this.currentElement.addEventListener("click",this.voiceCommandsCallBack.bind(this.currentElement,this.command)),this.createButton(this.element,this.currentElement))}return wearML.wearMLElements},this.onReceivedCommand=function(t){wearML.pollCommands()},this.pollCommands=function(){void 0!=wearML.ASRPolling&&(clearTimeout(wearML.ASRPolling),this.ASRPolling=null),wearML.ASRPolling=setTimeout(wearML.getCommands,1e3)},this.createOverrideDom=function(){this.btn=document.getElementById("wearHF_root_button"),void 0!=this.btn&&document.body.removeChild(this.btn),this.btn=document.createElement("BUTTON"),this.btn.id="wearHF_root_button",this.t=document.createTextNode("hf_wearml_override:"+this.generateXML()),this.btn.appendChild(this.t),this.btn.style.top=0,this.btn.style.left=0,this.btn.style.opacity="0.01",this.btn.style.position="fixed",this.theFirstChild=document.body.firstChild,document.body.insertBefore(this.btn,this.theFirstChild)},this.createButton=function(t,e){this.btn=document.getElementById(t.tag+"WML_NODE"),void 0!=this.btn&&document.body.removeChild(this.btn),this.btn=document.createElement("BUTTON"),this.btn.id=t.tag+"WML_NODE",this.t=document.createTextNode(t.tag),this.btn.style.fontSize="0.01px",this.btn.appendChild(this.t),this.btn.style.top=e.getBoundingClientRect().top,this.btn.style.left=e.getBoundingClientRect().left,this.btn.onclick=function(t){for(var e=0,o=wearML.wearMLElements.length;e<o;e++)t.srcElement.textContent===wearML.wearMLElements[e].tag&&(this.ele=document.getElementById(wearML.wearMLElements[e].id),"INPUT"===this.ele.tagName|"TEXTAREA"===this.ele.tagName?(this.ele.focus(),this.ele.click()):"SELECT"===this.ele.tagName?(this.event=document.createEvent("MouseEvents"),this.event.initMouseEvent("mousedown",!0,!0,window),this.ele.dispatchEvent(this.event)):(this.event=new Event("click"),this.ele.dispatchEvent(this.event)))},this.btn.style.opacity="0.01",this.btn.style.position="absolute",this.btn.style.width=e.offsetWidth,this.btn.style.height=e.offsetHeight,this.btn.style.zIndex="-1";document.body.firstChild;document.body.appendChild(this.btn),wearML.wearHFButtons.push(this.btn)},this.generateXML=function(){this.xml='<WearML><Package>com.android.webview</Package><Language>en_GB</Language><UniqueIdentifier id="web_app"/> ',document.title="hf_no_number";for(var t=0,e=wearML.wearMLElements.length;t<e;t++)this.command=wearML.wearMLElements[t].tag,this.styleId=wearML.wearMLElements[t].styleId,this.xml+="<View ",this.xml+='id="'+wearML.wearMLElements[t].id+'" ',void 0!=this.command&&(this.xml+='speech_command="no" '),this.style=this.getStyle(this.styleId),void 0!=this.style&&(this.xml+=this.wearMLParser(this.style,wearML.wearMLElements[t])),this.xml+="/> ",this.xml+="<View ",this.xml+='id="'+wearML.wearMLElements[t].tag+'WML_NODE"',this.style=wearML.getStyle(this.styleId),void 0!=this.style&&(this.xml+=this.wearMLParser(this.style,wearML.wearMLElements[t])),void 0!=this.command&&(this.xml+='speech_command="'+this.command+'" '),this.xml+="/> ";return this.xml+="</WearML>",this.utf8_to_b64(this.xml)},this.utf8_to_b64=function(t){return window.btoa(unescape(encodeURIComponent(t)))},this.getStyle=function(t){for(var e=0;e<document.styleSheets.length;e++)if(this.classes=document.styleSheets[e].rules||document.styleSheets[e].cssRules,null!=this.classes)for(var o=0;o<this.classes.length;o++)if(this.classes[o].selectorText==t)return this.classes[o].style},this.guid=function(){function t(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return t()+t()+"-"+t()+"-"+t()+"-"+t()+"-"+t()+t()+t()},this.getPosition=function(t){for(this.xPos=0,this.yPos=0;t;)"BODY"==t.tagName?(this.xScroll=t.scrollLeft||document.documentElement.scrollLeft,this.yScroll=t.scrollTop||document.documentElement.scrollTop,this.xPos+=t.offsetLeft-this.xScroll+t.clientLeft,this.yPos+=t.offsetTop-this.yScroll+t.clientTop):(this.xPos+=t.offsetLeft-t.scrollLeft+t.clientLeft,this.yPos+=t.offsetTop-t.scrollTop+t.clientTop),t=t.offsetParent;return{x:this.xPos,y:this.yPos}},this.wearMLParser=function(t,e){var o="",s=void 0!=t?t.getPropertyValue(this.root).trim():"",r=void 0!=t?t.getPropertyValue(this.text_field).trim():this.root_text_field,i=void 0!=t?t.getPropertyValue(this.overlay_show_number).trim():this.root_overlay_show_number,l=void 0!=t?t.getPropertyValue(this.overlay_show_text).trim():this.root_overlay_show_text,n=void 0!=t?t.getPropertyValue(this.overlay_persists).trim():this.root_overlay_persists,h=void 0!=t?t.getPropertyValue(this.overlay_orientation).trim():this.root_overlay_orientation,a=void 0!=t?t.getPropertyValue(this.overlay_background_color).trim():this.root_overlay_background_color,d=void 0!=t?t.getPropertyValue(this.overlay_text_color).trim():this.root_overlay_text_color,_=void 0!=t?t.getPropertyValue(this.overlay_border_color).trim():this.root_overlay_border_color,c=void 0!=t?t.getPropertyValue(this.overlay_anchor_hv).trim():this.root_overlay_anchor_hv,m=void 0!=t?t.getPropertyValue(this.overlay_show_dot).trim():this.root_overlay_show_dot,y=void 0!=t?t.getPropertyValue(this.overlay_show_icon).trim():this.root_overlay_show_icon,u=void 0!=t?t.getPropertyValue(this.overlay_offset).trim():this.root_overlay_offset,v=void 0!=t?t.getPropertyValue(this.hf_scroll).trim():this.root_hf_scroll,w=void 0!=t?t.getPropertyValue(this.barcode).trim():"",b=void 0!=t?t.getPropertyValue(this.global).trim():"",f=void 0!=t?t.getPropertyValue(this.hide_help).trim():"",g=void 0!=t?t.getPropertyValue(this.broadcast_results).trim():"";return""!=s&&"true"==s&&(this.root_text_field=r,this.root_overlay_show_number=i,this.root_overlay_show_text=l,this.root_overlay_persists=n,this.root_overlay_orientation=h,this.root_overlay_background_color=a,this.root_overlay_text_color=d,this.root_overlay_border_color=_,this.root_overlay_anchor_hv=c,this.root_overlay_show_dot=m,this.root_overlay_show_icon=y,this.root_overlay_offset=u,this.root_hf_scroll=v,this.root_hide_help=f),""!=r&&(o+="text_field="+r+" "),""!=i&&(o+="true"==i?'overlay_show_number="yes" ':'overlay_show_number="no" '),""!=l&&(o+="true"==l?'overlay_show_text="yes" ':'overlay_show_text="no" '),""!=n&&(o+="true"==n?'overlay_persists="yes" ':'overlay_persists="no" '),""!=h&&(o+="overlay_orientation="+h+" "),""!=a&&(o+="overlay_background_color="+a+" "),""!=d&&(o+="overlay_text_color="+d+" "),""!=_&&(o+="overlay_border_color="+_+" "),""!=c&&(o+="overlay_anchor="+c+" "),""!=m&&(o+="true"==m?'overlay_show_dot="yes" ':'overlay_show_dot="no" '),""!=y&&(o+="true"==y?'overlay_show_icon="yes" ':'overlay_show_icon="no" '),""!=u&&(o+="overlay_offset="+u+" "),""!=v&&(o+="scroll="+v+" "),""!=w&&(o+="barcode="+w+" "),""!=f&&(o+="barcode="+w+" "),""!=b&&(o+="true"==b?'global_commands="yes" ':'global_commands="no" '),""!=g&&(o+="true"==g?'broadcast_results="yes" ':'broadcast_results="no" '),o}};